<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مسار القانون - مركز أورنمو | نظام إدارة الخرائط الامتحانية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* ===== متغيرات نظام القانون ===== */
        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --accent-color: #3949ab;
            --law-blue: #1a237e;
            --law-gold: #d4af37;
            --success-color: #2e7d32;
            --warning-color: #f57c00;
            --danger-color: #d32f2f;
            --info-color: #0288d1;
            --light-color: #f5f7fa;
            --dark-color: #0d1b3e;
            --sidebar-width: 280px;
            --sidebar-width-mobile: 90%;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 10px;
            --transition: all 0.3s ease;
        }

        /* ===== التهيئة العامة ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'Arial', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
        }

        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            font-size: 1rem;
        }

        /* ===== شاشة الدخول ===== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--law-blue) 0%, var(--dark-color) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 1rem;
        }

        .login-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .login-logo {
            font-size: 3rem;
            color: var(--law-blue);
            margin-bottom: 1rem;
        }

        .system-title {
            color: var(--law-blue);
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .system-subtitle {
            color: var(--accent-color);
            font-size: 1rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .center-name {
            color: var(--law-gold);
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--law-gold);
            padding-bottom: 10px;
            display: inline-block;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: right;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.1);
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            min-width: 120px;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--law-blue) 0%, var(--accent-color) 100%);
            color: white;
        }

        .btn-primary:hover, .btn-primary:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 35, 126, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #43a047 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #ff9800 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #f44336 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #29b6f6 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            opacity: 0.9;
        }

        /* ===== الحاوية الرئيسية ===== */
        .container {
            display: flex;
            min-height: 100vh;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .container.show {
            opacity: 1;
        }

        /* ===== الشريط الجانبي - تصميم متجاوب ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--law-blue) 0%, var(--dark-color) 100%);
            color: white;
            padding: 1.5rem 1rem;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }

        .sidebar-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .system-logo {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--law-gold);
        }

        .system-title-sidebar {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }

        .center-name-sidebar {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
        }

        /* ===== قائمة الهاتف ===== */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
            background: var(--law-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .mobile-menu-btn i {
            transition: transform 0.3s ease;
        }

        .mobile-menu-btn.active i {
            transform: rotate(90deg);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* ===== القائمة الجانبية ===== */
        .nav-menu {
            list-style: none;
            margin-bottom: 2rem;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 8px;
            transition: var(--transition);
            cursor: pointer;
            touch-action: manipulation;
            min-height: 50px;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(212, 175, 55, 0.2);
            color: white;
            transform: translateX(-5px);
            border-right: 3px solid var(--law-gold);
        }

        .nav-icon {
            margin-left: 12px;
            font-size: 1.2rem;
            width: 24px;
            color: var(--law-gold);
        }

        /* ===== المحتوى الرئيسي ===== */
        .main-content {
            flex: 1;
            margin-right: var(--sidebar-width);
            padding: 1rem;
            min-height: 100vh;
            transition: margin-right 0.3s ease;
        }

        /* ===== الهيدر الرئيسي ===== */
        .main-header {
            background: white;
            padding: 1.5rem 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            font-size: 1.3rem;
            color: var(--law-blue);
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .user-info {
            text-align: left;
            min-width: 150px;
        }

        .user-name {
            font-weight: 600;
            color: var(--law-blue);
        }

        .user-role {
            font-size: 0.9rem;
            color: #666;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--law-blue) 0%, var(--accent-color) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* ===== نظام المربعات للداشبورد ===== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .dashboard-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.2rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            border-top: 4px solid var(--law-gold);
            height: 100%;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--law-blue) 0%, var(--accent-color) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            margin-left: 15px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--law-blue);
            flex: 1;
        }

        .card-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--law-blue);
            margin: 0.5rem 0;
        }

        .card-desc {
            color: #666;
            margin-bottom: 1rem;
            flex: 1;
            font-size: 0.9rem;
        }

        /* ===== أقسام النظام ===== */
        .system-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            display: none;
        }

        .system-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--law-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        /* ===== الجداول - تحسين للشاشات الصغيرة ===== */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }

        .data-table th {
            background: linear-gradient(135deg, var(--law-blue) 0%, var(--accent-color) 100%);
            color: white;
            padding: 0.8rem;
            text-align: right;
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .data-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
        }

        .data-table tbody tr:hover {
            background: #f9f9f9;
        }

        /* ===== الإشعارات ===== */
        .alert-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2000;
            max-width: 90%;
            width: 400px;
        }

        .alert {
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem 1.2rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateX(-100%);
            opacity: 0;
            transition: all 0.5s ease;
            font-size: 0.9rem;
        }

        .alert.show {
            transform: translateX(0);
            opacity: 1;
        }

        .alert-success {
            border-right: 4px solid var(--success-color);
        }

        .alert-warning {
            border-right: 4px solid var(--warning-color);
        }

        .alert-danger {
            border-right: 4px solid var(--danger-color);
        }

        .alert-info {
            border-right: 4px solid var(--info-color);
        }

        /* ===== النماذج المنبثقة - تحسين للجوال ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            padding: 1rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--law-blue) 0%, var(--accent-color) 100%);
            color: white;
            padding: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            transition: var(--transition);
            touch-action: manipulation;
        }

        .modal-close:hover {
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(90vh - 120px);
        }

        /* ===== منطقة سحب وإفلات Excel ===== */
        .drop-zone {
            border: 3px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin: 1rem 0;
            touch-action: manipulation;
        }

        .drop-zone:hover, .drop-zone:active {
            border-color: var(--accent-color);
            background: #f8f9fa;
        }

        .drop-zone i {
            font-size: 3rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }

        /* ===== خرائط الجلوس - تحسين للجوال ===== */
        .seat-map-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .seat-map {
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--shadow);
            border: 2px solid #eee;
        }

        .seat-map-header {
            background: linear-gradient(135deg, var(--law-blue) 0%, var(--accent-color) 100%);
            color: white;
            padding: 0.8rem;
            border-radius: 8px 8px 0 0;
            margin: -1rem -1rem 1rem -1rem;
            text-align: center;
        }

        .seat-map-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .seats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
            margin-top: 1rem;
        }

        .seat {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px;
            text-align: center;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
        }

        .seat:hover, .seat:active {
            background: #e0e0e0;
            transform: scale(1.05);
        }

        .seat.occupied {
            background: #e8f5e9;
            border-color: var(--success-color);
        }

        .seat.empty {
            background: #f5f5f5;
            border-color: #ddd;
        }

        .student-name {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 0.7rem;
        }

        .student-id {
            font-size: 0.65rem;
            color: #666;
        }

        /* ===== التحكم بالنظام ===== */
        .system-controls {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-top: 1.5rem;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.8rem;
        }

        .control-btn {
            padding: 1rem;
            border: 2px solid transparent;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            touch-action: manipulation;
        }

        .control-btn:hover, .control-btn:active {
            background: var(--law-blue);
            color: white;
            transform: translateY(-2px);
        }

        .control-btn.danger {
            background: #ffebee;
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .control-btn.danger:hover, .control-btn.danger:active {
            background: var(--danger-color);
            color: white;
        }

        /* ===== شريط البحث والتصفية - تحسين للجوال ===== */
        .filter-bar {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .filter-row {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 100%;
        }

        .search-box input, .filter-select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        /* ===== بطاقات الإحصائيات ===== */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.2rem;
            box-shadow: var(--shadow);
            text-align: center;
            border-top: 4px solid var(--law-gold);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 2rem;
            color: var(--law-blue);
            margin-bottom: 0.8rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--law-blue);
            margin: 0.5rem 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.85rem;
        }

        /* ===== أزرار صغيرة ===== */
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            min-width: auto;
            gap: 5px;
        }

        /* ===== تحسينات الطباعة ===== */
        @media print {
            .sidebar, .main-header, .action-buttons, .modal, .alert-container, 
            .mobile-menu-btn, .sidebar-overlay {
                display: none !important;
            }
            
            .main-content {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }
            
            .seat-map {
                break-inside: avoid;
                border: 2px solid #000;
                margin: 10px;
            }
            
            .btn {
                display: none !important;
            }
            
            .print-report {
                display: block !important;
            }
        }

        /* ===== إعدادات متجاوبة ===== */
        /* شاشات كبيرة (أجهزة سطح المكتب) */
        @media (min-width: 1201px) {
            .sidebar {
                width: var(--sidebar-width);
            }
            
            .main-content {
                margin-right: var(--sidebar-width);
            }
        }

        /* شاشات متوسطة (تابلت وأجهزة لوحية) */
        @media (max-width: 1200px) and (min-width: 769px) {
            .sidebar {
                width: 220px;
            }
            
            .main-content {
                margin-right: 220px;
                padding: 1.2rem;
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .seat-map-container {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
            
            .action-buttons {
                gap: 0.5rem;
            }
            
            .btn {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
                min-width: 110px;
            }
        }

        /* شاشات صغيرة (هواتف وأجهزة لوحية صغيرة) */
        @media (max-width: 768px) {
            html {
                font-size: 15px;
            }
            
            /* زر القائمة للهاتف */
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* القائمة الجانبية للهاتف */
            .sidebar {
                width: var(--sidebar-width-mobile);
                transform: translateX(100%);
                z-index: 1000;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-right: 0 !important;
                padding: 0.8rem;
                padding-bottom: 80px;
            }
            
            /* تحسين الهيدر */
            .main-header {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .header-top {
                flex-direction: column;
                align-items: stretch;
                gap: 0.8rem;
            }
            
            .user-menu {
                justify-content: space-between;
                order: 2;
            }
            
            .header-title {
                order: 1;
                justify-content: center;
                text-align: center;
            }
            
            /* تحسين الجداول */
            .data-table {
                min-width: 700px;
            }
            
            .data-table th, .data-table td {
                padding: 0.6rem;
                font-size: 0.85rem;
            }
            
            /* تحسين البطاقات */
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.8rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-icon {
                font-size: 1.8rem;
            }
            
            .stat-value {
                font-size: 1.8rem;
            }
            
            /* تحسين أزرار الإجراءات */
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
                padding: 0.8rem;
                font-size: 0.9rem;
            }
            
            /* تحسين خرائط الجلوس */
            .seat-map-container {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .seat-map {
                padding: 0.8rem;
            }
            
            .seats-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
                gap: 6px;
            }
            
            .seat {
                padding: 6px;
                min-height: 45px;
                font-size: 0.7rem;
            }
            
            /* تحسين النماذج المنبثقة */
            .modal-content {
                width: 95%;
                margin: 0.5rem;
                max-height: 85vh;
            }
            
            .modal-body {
                padding: 1rem;
                max-height: calc(85vh - 100px);
            }
            
            /* تحسين التحكم بالنظام */
            .control-buttons {
                grid-template-columns: 1fr;
            }
            
            /* تحسين شريط البحث */
            .filter-bar {
                padding: 0.8rem;
            }
            
            .filter-row {
                flex-direction: column;
            }
            
            .search-box input, .filter-select {
                padding: 0.7rem;
            }
            
            /* تحسين الأليرت */
            .alert-container {
                max-width: 95%;
                left: 2.5%;
            }
            
            .alert {
                padding: 0.8rem 1rem;
                font-size: 0.85rem;
            }
        }

        /* شاشات صغيرة جداً (هواتف صغيرة) */
        @media (max-width: 480px) {
            html {
                font-size: 14px;
            }
            
            .login-container {
                padding: 1.5rem;
            }
            
            .login-logo {
                font-size: 2.5rem;
            }
            
            .system-title {
                font-size: 1.5rem;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .dashboard-card {
                padding: 1rem;
            }
            
            .card-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                margin-left: 10px;
            }
            
            .section-title {
                font-size: 1.2rem;
            }
            
            .data-table {
                min-width: 800px;
            }
            
            .btn {
                padding: 0.7rem;
                font-size: 0.85rem;
            }
            
            .seats-grid {
                grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
            }
            
            .seat {
                min-height: 40px;
                font-size: 0.65rem;
            }
        }

        /* شاشات الطاولة (جهاز أفقي) */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .seat-map-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-cards {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .action-buttons {
                flex-direction: row;
            }
            
            .btn {
                width: auto;
            }
        }

        /* ===== تحميل ===== */
        .loader {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--law-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            font-size: 1.2rem;
        }

        /* ===== فورم المجموعات ===== */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (min-width: 768px) {
            .form-row {
                flex-direction: row;
            }
        }

        .form-group {
            flex: 1;
            min-width: 100%;
        }

        @media (min-width: 768px) {
            .form-group {
                min-width: 200px;
            }
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--law-blue);
        }

        /* ===== علامات الحالة ===== */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-active {
            background: #e8f5e9;
            color: var(--success-color);
        }

        .status-inactive {
            background: #ffebee;
            color: var(--danger-color);
        }

        .status-warning {
            background: #fff3e0;
            color: var(--warning-color);
        }

        /* ===== تحسينات عامة ===== */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #ddd;
        }

        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 1rem; }
        .mt-4 { margin-top: 1.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .text-center { text-align: center; }

        /* ===== تقرير الطباعة ===== */
        .print-report {
            display: none;
            background: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .print-header {
            text-align: center;
            margin-bottom: 1.5rem;
            border-bottom: 3px solid var(--law-gold);
            padding-bottom: 1rem;
        }

        .print-title {
            color: var(--law-blue);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .print-subtitle {
            color: var(--accent-color);
            font-size: 1.1rem;
        }

        .print-date {
            color: #666;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .print-section {
            margin-bottom: 1.5rem;
            page-break-inside: avoid;
        }

        .print-section-title {
            color: var(--law-blue);
            font-size: 1.2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #eee;
        }

        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .print-table th {
            background: #f5f5f5;
            color: var(--law-blue);
            padding: 0.6rem;
            text-align: right;
            border: 1px solid #ddd;
        }

        .print-table td {
            padding: 0.5rem;
            border: 1px solid #ddd;
        }

        .print-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .print-footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.85rem;
        }

        .print-signature {
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-around;
        }

        .signature-box {
            text-align: center;
            width: 150px;
        }

        .signature-line {
            border-top: 1px solid #000;
            width: 100%;
            margin: 1.5rem 0 0.5rem 0;
        }

        /* ===== أزرار الطباعة ===== */
        .print-btn {
            background: #6c757d;
            color: white;
        }

        .print-btn:hover, .print-btn:active {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* ===== تحسينات للعرض العمودي ===== */
        @media (orientation: portrait) {
            .seat-map-container {
                grid-template-columns: 1fr;
            }
            
            .seats-grid {
                grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
            }
        }

        /* ===== تحسينات للعرض الأفقي ===== */
        @media (orientation: landscape) and (max-height: 600px) {
            .main-header {
                padding: 0.8rem;
            }
            
            .header-top {
                flex-direction: row;
            }
            
            .header-title {
                font-size: 1.1rem;
            }
            
            .user-name {
                font-size: 0.9rem;
            }
            
            .user-role {
                font-size: 0.8rem;
            }
            
            .avatar {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }

        /* ===== تحسينات للكتابة والملامسة ===== */
        input, select, textarea, button {
            font-size: 16px; /* منع التكبير في iOS */
        }

        @media screen and (-webkit-min-device-pixel-ratio:0) {
            select:focus, textarea:focus, input:focus {
                font-size: 16px;
            }
        }

        /* ===== تحسينات للأجهزة التي تدعم hover ===== */
        @media (hover: hover) and (pointer: fine) {
            .nav-link:hover, .nav-link.active {
                transform: translateX(-5px);
            }
            
            .dashboard-card:hover {
                transform: translateY(-5px);
            }
            
            .stat-card:hover {
                transform: translateY(-5px);
            }
            
            .seat:hover {
                transform: scale(1.05);
            }
            
            .btn:hover, .control-btn:hover {
                transform: translateY(-2px);
            }
        }

        /* ===== تحسينات للأجهزة التي لا تدعم hover (الهواتف) ===== */
        @media (hover: none) and (pointer: coarse) {
            .nav-link:active, .nav-link.active {
                background: rgba(212, 175, 55, 0.2);
                transform: scale(0.98);
            }
            
            .dashboard-card:active {
                transform: scale(0.98);
            }
            
            .btn:active, .control-btn:active {
                transform: scale(0.98);
            }
            
            .seat:active {
                transform: scale(0.95);
            }
        }
    </style>
</head>
<body>
    <!-- شاشة الدخول -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-balance-scale"></i>
            </div>
            <h1 class="system-title">مسار القانون</h1>
            <p class="system-subtitle">نظام إدارة الخرائط الامتحانية</p>
            <div class="center-name">مركز أورنمو</div>
            
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" class="form-control" id="username" placeholder="اسم المستخدم" value="admin" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="password" placeholder="كلمة المرور" value="admin" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> دخول النظام
                </button>
            </form>
            
            <div class="mt-4" style="color: #666; font-size: 0.9rem;">
                <p>اسم المستخدم: admin | كلمة المرور: admin</p>
                <p>نظام فارغ وجاهز للاستخدام الفوري</p>
            </div>
        </div>
    </div>

    <!-- زر القائمة للهاتف -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- طبقة التعتيم للقائمة الجانبية -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>

    <!-- حاوية الإشعارات -->
    <div class="alert-container" id="alertContainer"></div>

    <!-- شاشة التحميل -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <p class="mt-3">جاري المعالجة...</p>
    </div>

    <!-- الهيكل الرئيسي -->
    <div class="container" id="mainContainer">
        <!-- الشريط الجانبي -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="system-logo">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div>
                    <div class="system-title-sidebar">مسار القانون</div>
                    <div class="center-name-sidebar">مركز أورنمو</div>
                </div>
            </div>

            <!-- القائمة الجانبية -->
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showSection('dashboard'); toggleMobileMenu();">
                        <i class="fas fa-tachometer-alt nav-icon"></i>
                        <span class="nav-text">لوحة التحكم</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('initial-setup'); toggleMobileMenu();">
                        <i class="fas fa-cogs nav-icon"></i>
                        <span class="nav-text">الإعدادات الأولية</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('students'); toggleMobileMenu();">
                        <i class="fas fa-user-graduate nav-icon"></i>
                        <span class="nav-text">شؤون الطلاب</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('halls'); toggleMobileMenu();">
                        <i class="fas fa-building nav-icon"></i>
                        <span class="nav-text">إدارة القاعات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('distribution'); toggleMobileMenu();">
                        <i class="fas fa-map-marked-alt nav-icon"></i>
                        <span class="nav-text">توزيع الخرائط</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('monitoring'); toggleMobileMenu();">
                        <i class="fas fa-eye nav-icon"></i>
                        <span class="nav-text">إدارة المراقبة</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('reports'); toggleMobileMenu();">
                        <i class="fas fa-chart-bar nav-icon"></i>
                        <span class="nav-text">التقارير والإحصائيات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('system'); toggleMobileMenu();">
                        <i class="fas fa-shield-alt nav-icon"></i>
                        <span class="nav-text">النظام والصيانة</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- المحتوى الرئيسي -->
        <div class="main-content" id="mainContent">
            <!-- الهيدر الرئيسي -->
            <header class="main-header">
                <div class="header-top">
                    <div class="header-title">
                        <i class="fas fa-tachometer-alt"></i>
                        <span id="pageTitle">لوحة التحكم الرئيسية</span>
                    </div>
                    <div class="user-menu">
                        <div class="user-info">
                            <div class="user-name">مدير النظام</div>
                            <div class="user-role">مركز أورنمو</div>
                        </div>
                        <div class="avatar">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>
            </header>

            <!-- قسم لوحة التحكم -->
            <div class="system-section active" id="dashboardSection">
                <div class="stats-cards">
                    <div class="stat-card">
                        <i class="fas fa-user-graduate stat-icon"></i>
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-label">إجمالي الطلاب</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-building stat-icon"></i>
                        <div class="stat-value" id="totalHalls">0</div>
                        <div class="stat-label">إجمالي القاعات</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-chair stat-icon"></i>
                        <div class="stat-value" id="totalSeats">0</div>
                        <div class="stat-label">إجمالي المقاعد</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle stat-icon"></i>
                        <div class="stat-value" id="distributedStudents">0</div>
                        <div class="stat-label">طلاب موزعين</div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card" onclick="showSection('initial-setup')">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="card-title">الإعدادات الأولية</div>
                        </div>
                        <div class="card-desc">تجهيز النظام من الصفر، إضافة الأقسام، المراحل، والمواد الدراسية</div>
                        <div class="card-value">ابدأ هنا</div>
                    </div>

                    <div class="dashboard-card" onclick="showSection('students')">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div class="card-title">شؤون الطلاب</div>
                        </div>
                        <div class="card-desc">إدارة بيانات طلاب القانون، الاستيراد من Excel، والتحديث</div>
                        <div class="card-value" id="dashboardStudentCount">0 طالب</div>
                    </div>

                    <div class="dashboard-card" onclick="showSection('halls')">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="card-title">إدارة القاعات</div>
                        </div>
                        <div class="card-desc">إضافة القاعات، تحديد السعة، وتنظيم المقاعد</div>
                        <div class="card-value" id="dashboardHallCount">0 قاعة</div>
                    </div>

                    <div class="dashboard-card" onclick="showSection('distribution')">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-map-marked-alt"></i>
                            </div>
                            <div class="card-title">توزيع الخرائط</div>
                        </div>
                        <div class="card-desc">التوزيع الذكي واليدوي للطلاب على القاعات</div>
                        <div class="card-value">محرك ذكي</div>
                    </div>

                    <div class="dashboard-card" onclick="showSection('reports')">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="card-title">التقارير والإحصائيات</div>
                        </div>
                        <div class="card-desc">تقارير الإشغال، الخرائط الجاهزة للطباعة، والإحصاءات</div>
                        <div class="card-value">PDF/Excel</div>
                    </div>

                    <div class="dashboard-card" onclick="showSection('system')">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="card-title">النظام والصيانة</div>
                        </div>
                        <div class="card-desc">النسخ الاحتياطي، تصفير النظام، وإعدادات الأمان</div>
                        <div class="card-value">أدوات</div>
                    </div>
                </div>

                <div class="action-buttons mt-4">
                    <button class="btn btn-info" onclick="printDashboardReport()">
                        <i class="fas fa-print"></i> طباعة تقرير الداشبورد
                    </button>
                    <button class="btn btn-success" onclick="generateFullReport()">
                        <i class="fas fa-file-pdf"></i> تقرير كامل PDF
                    </button>
                </div>
            </div>

            <!-- قسم الإعدادات الأولية -->
            <div class="system-section" id="initialSetupSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-cogs"></i>
                        الإعدادات الأولية للنظام
                    </h2>
                    <div class="action-buttons">
                        <button class="btn btn-info" onclick="importJSON('settings')">
                            <i class="fas fa-file-import"></i> استيراد JSON
                        </button>
                        <button class="btn print-btn" onclick="printSectionReport('initial-setup')">
                            <i class="fas fa-print"></i> طباعة التقرير
                        </button>
                    </div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>هام:</strong> هذه الخطوة الأولى لتجهيز النظام. يجب إكمالها قبل استخدام النظام.
                </div>

                <div class="dashboard-grid mt-4">
                    <div class="dashboard-card" onclick="addDepartment()">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-sitemap"></i>
                            </div>
                            <div class="card-title">إضافة أقسام</div>
                        </div>
                        <div class="card-desc">إضافة الأقسام الأكاديمية لطلبة القانون (مثل: القانون العام، القانون الخاص)</div>
                    </div>

                    <div class="dashboard-card" onclick="addStage()">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <div class="card-title">إضافة مراحل</div>
                        </div>
                        <div class="card-desc">تحديد المراحل الدراسية (الأولى، الثانية، الثالثة، الرابعة)</div>
                    </div>

                    <div class="dashboard-card" onclick="addSubject()">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="card-title">إضافة مواد</div>
                        </div>
                        <div class="card-desc">إضافة المواد الدراسية لكل مرحلة (مثل: المدخل لدراسة القانون، القانون الدستوري)</div>
                    </div>

                    <div class="dashboard-card" onclick="showImportModal('students')">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-file-import"></i>
                            </div>
                            <div class="card-title">استيراد أولي</div>
                        </div>
                        <div class="card-desc">استيراد بيانات الطلاب من ملف Excel جاهز</div>
                    </div>
                </div>

                <div class="system-controls mt-4">
                    <h3 class="section-title mb-3">ملخص الإعدادات الحالية</h3>
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-value" id="deptCount">0</div>
                            <div class="stat-label">الأقسام المضافة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stageCount">0</div>
                            <div class="stat-label">المراحل المضافة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="subjectCount">0</div>
                            <div class="stat-label">المواد المضافة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="initialStudentCount">0</div>
                            <div class="stat-label">الطلاب المسجلين</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button class="btn btn-success" onclick="exportJSON('settings')">
                            <i class="fas fa-file-export"></i> تصدير الإعدادات كـ JSON
                        </button>
                        <button class="btn btn-primary" onclick="printSetupReport()">
                            <i class="fas fa-print"></i> طباعة تقرير الإعدادات
                        </button>
                    </div>
                </div>

                <!-- تقرير الطباعة للإعدادات -->
                <div class="print-report" id="setupPrintReport">
                    <!-- محتوى التقرير - كما كان في الكود الأصلي -->
                </div>
            </div>

            <!-- قسم شؤون الطلاب -->
            <div class="system-section" id="studentsSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-user-graduate"></i>
                        شؤون طلاب القانون
                    </h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="addStudent()">
                            <i class="fas fa-user-plus"></i> إضافة طالب
                        </button>
                        <button class="btn btn-success" onclick="showImportModal('students')">
                            <i class="fas fa-file-import"></i> استيراد Excel
                        </button>
                        <button class="btn btn-info" onclick="exportStudentsExcel()">
                            <i class="fas fa-file-export"></i> تصدير Excel
                        </button>
                        <button class="btn print-btn" onclick="printSectionReport('students')">
                            <i class="fas fa-print"></i> طباعة
                        </button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="search-box">
                        <input type="text" class="form-control" id="studentSearch" placeholder="بحث عن طالب بالاسم أو الرقم الجامعي..." oninput="filterStudents()">
                    </div>
                    <div class="filter-row">
                        <select class="form-control filter-select" id="studentDeptFilter" onchange="filterStudents()">
                            <option value="all">جميع الأقسام</option>
                        </select>
                        <select class="form-control filter-select" id="studentStageFilter" onchange="filterStudents()">
                            <option value="all">جميع المراحل</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="studentsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الرقم الجامعي</th>
                                <th>اسم الطالب</th>
                                <th>القسم</th>
                                <th>المرحلة</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </tbody>
                    </table>
                </div>

                <!-- تقرير الطباعة للطلاب -->
                <div class="print-report" id="studentsPrintReport">
                    <!-- محتوى التقرير - كما كان في الكود الأصلي -->
                </div>
            </div>

            <!-- قسم إدارة القاعات -->
            <div class="system-section" id="hallsSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-building"></i>
                        إدارة القاعات الامتحانية
                    </h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="addHall()">
                            <i class="fas fa-plus"></i> إضافة قاعة
                        </button>
                        <button class="btn btn-success" onclick="showImportModal('halls')">
                            <i class="fas fa-file-import"></i> استيراد Excel
                        </button>
                        <button class="btn print-btn" onclick="printSectionReport('halls')">
                            <i class="fas fa-print"></i> طباعة
                        </button>
                    </div>
                </div>

                <div class="stats-cards">
                    <div class="stat-card">
                        <i class="fas fa-door-open stat-icon"></i>
                        <div class="stat-value" id="availableSeats">0</div>
                        <div class="stat-label">مقاعد متاحة</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-users stat-icon"></i>
                        <div class="stat-value" id="occupiedSeatsStat">0</div>
                        <div class="stat-label">مقاعد مشغولة</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-percentage stat-icon"></i>
                        <div class="stat-value" id="occupancyRate">0%</div>
                        <div class="stat-label">نسبة الإشغال</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-exclamation-triangle stat-icon"></i>
                        <div class="stat-value" id="warningHalls">0</div>
                        <div class="stat-label">قاعات ممتلئة</div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="hallsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اسم القاعة</th>
                                <th>السعة</th>
                                <th>المشغول</th>
                                <th>المتاح</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="hallsTableBody">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </tbody>
                    </table>
                </div>

                <!-- تقرير الطباعة للقاعات -->
                <div class="print-report" id="hallsPrintReport">
                    <!-- محتوى التقرير - كما كان في الكود الأصلي -->
                </div>
            </div>

            <!-- قسم توزيع الخرائط -->
            <div class="system-section" id="distributionSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-map-marked-alt"></i>
                        توزيع الخرائط الامتحانية
                    </h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="manualDistribution()">
                            <i class="fas fa-hand-pointer"></i> توزيع يدوي
                        </button>
                        <button class="btn btn-success" onclick="autoDistribution('alphabetical')">
                            <i class="fas fa-robot"></i> توزيع أبجدي
                        </button>
                        <button class="btn btn-warning" onclick="autoDistribution('random')">
                            <i class="fas fa-random"></i> توزيع عشوائي
                        </button>
                        <button class="btn btn-danger" onclick="clearDistribution()">
                            <i class="fas fa-trash"></i> مسح التوزيع
                        </button>
                        <button class="btn print-btn" onclick="printSectionReport('distribution')">
                            <i class="fas fa-print"></i> طباعة
                        </button>
                    </div>
                </div>

                <div class="alert alert-warning" id="distributionAlert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>ملاحظة:</strong> يجب إضافة الطلاب والقاعات أولاً قبل التوزيع.
                </div>

                <div class="seat-map-container" id="seatMapsContainer">
                    <!-- سيتم ملؤها ديناميكياً بالخرائط -->
                </div>

                <!-- تقرير الطباعة للتوزيع -->
                <div class="print-report" id="distributionPrintReport">
                    <!-- محتوى التقرير - كما كان في الكود الأصلي -->
                </div>
            </div>

            <!-- قسم إدارة المراقبة -->
            <div class="system-section" id="monitoringSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-eye"></i>
                        إدارة المراقبة والمراقبين
                    </h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="addMonitor()">
                            <i class="fas fa-user-plus"></i> إضافة مراقب
                        </button>
                        <button class="btn btn-success" onclick="assignMonitorsAuto()">
                            <i class="fas fa-robot"></i> توزيع تلقائي
                        </button>
                        <button class="btn print-btn" onclick="printSectionReport('monitoring')">
                            <i class="fas fa-print"></i> طباعة
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="monitorsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اسم المراقب</th>
                                <th>رقم الهاتف</th>
                                <th>عدد القاعات</th>
                                <th>عدد الطلاب</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="monitorsTableBody">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </tbody>
                    </table>
                </div>

                <!-- تقرير الطباعة للمراقبين -->
                <div class="print-report" id="monitoringPrintReport">
                    <!-- محتوى التقرير - كما كان في الكود الأصلي -->
                </div>
            </div>

            <!-- قسم التقارير والإحصائيات -->
            <div class="system-section" id="reportsSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-bar"></i>
                        التقارير والإحصائيات
                    </h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="generateSeatMapsPDF()">
                            <i class="fas fa-file-pdf"></i> طباعة خرائط الجلوس
                        </button>
                        <button class="btn btn-success" onclick="exportReportExcel()">
                            <i class="fas fa-file-excel"></i> تصدير تقرير Excel
                        </button>
                        <button class="btn btn-info" onclick="printDistributionReport()">
                            <i class="fas fa-print"></i> طباعة تقرير التوزيع
                        </button>
                        <button class="btn btn-danger" onclick="generateFullReport()">
                            <i class="fas fa-file-pdf"></i> تقرير كامل PDF
                        </button>
                    </div>
                </div>

                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-value" id="reportStudentCount">0</div>
                        <div class="stat-label">إجمالي الطلاب</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="reportHallCount">0</div>
                        <div class="stat-label">إجمالي القاعات</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="reportOccupancy">0%</div>
                        <div class="stat-label">متوسط الإشغال</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="reportMonitorCount">0</div>
                        <div class="stat-label">عدد المراقبين</div>
                    </div>
                </div>

                <div class="seat-map-container mt-4">
                    <div class="seat-map">
                        <div class="seat-map-header">
                            <div class="seat-map-title">تقرير الإشغال حسب الأقسام</div>
                        </div>
                        <canvas id="departmentChart" height="200"></canvas>
                    </div>
                    
                    <div class="seat-map">
                        <div class="seat-map-header">
                            <div class="seat-map-title">توزيع الطلاب حسب المراحل</div>
                        </div>
                        <canvas id="stageChart" height="200"></canvas>
                    </div>
                </div>

                <!-- تقرير الطباعة الكامل -->
                <div class="print-report" id="fullPrintReport">
                    <!-- محتوى التقرير - كما كان في الكود الأصلي -->
                </div>
            </div>

            <!-- قسم النظام والصيانة -->
            <div class="system-section" id="systemSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-shield-alt"></i>
                        النظام والصيانة
                    </h2>
                    <div class="action-buttons">
                        <button class="btn print-btn" onclick="printSystemReport()">
                            <i class="fas fa-print"></i> طباعة تقرير النظام
                        </button>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card" onclick="backupSystem()">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-save"></i>
                            </div>
                            <div class="card-title">نسخ احتياطي</div>
                        </div>
                        <div class="card-desc">حفظ نسخة احتياطية كاملة للنظام بصيغة JSON</div>
                    </div>

                    <div class="dashboard-card" onclick="restoreSystem()">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-upload"></i>
                            </div>
                            <div class="card-title">استعادة نسخة</div>
                        </div>
                        <div class="card-desc">استعادة النظام من نسخة احتياطية سابقة</div>
                    </div>

                    <div class="dashboard-card" onclick="exportFullData()">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="card-title">تصدير كامل البيانات</div>
                        </div>
                        <div class="card-desc">تصدير جميع بيانات النظام (طلاب، قاعات، خرائط)</div>
                    </div>

                    <div class="dashboard-card" onclick="showResetModal()">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-trash-alt"></i>
                            </div>
                            <div class="card-title">تصفير النظام</div>
                        </div>
                        <div class="card-desc">مسح جميع البيانات والعودة للحالة المصنعية</div>
                    </div>
                </div>

                <div class="system-controls mt-4">
                    <h3 class="section-title mb-3">معلومات النظام</h3>
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-value">مسار القانون</div>
                            <div class="stat-label">اسم النظام</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">مركز أورنمو</div>
                            <div class="stat-label">المؤسسة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">1.0</div>
                            <div class="stat-label">الإصدار</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="dataSize">0 KB</div>
                            <div class="stat-label">حجم البيانات</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button class="btn btn-success" onclick="exportJSON('all')">
                            <i class="fas fa-file-export"></i> تصدير كامل JSON
                        </button>
                        <button class="btn btn-primary" onclick="printSystemInfo()">
                            <i class="fas fa-print"></i> طباعة معلومات النظام
                        </button>
                    </div>
                </div>

                <!-- تقرير الطباعة للنظام -->
                <div class="print-report" id="systemPrintReport">
                    <!-- محتوى التقرير - كما كان في الكود الأصلي -->
                </div>
            </div>
        </div>
    </div>

    <!-- النماذج المنبثقة -->

    <!-- نموذج استيراد Excel -->
    <div class="modal" id="importExcelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">استيراد بيانات من Excel</h3>
                <button class="modal-close" onclick="hideModal('importExcelModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="drop-zone" id="excelDropZone" onclick="document.getElementById('excelFileInput').click()">
                    <i class="fas fa-file-excel"></i>
                    <h4>اسحب وأفلت ملف Excel هنا</h4>
                    <p>أو انقر لاختيار ملف</p>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileSelect(this.files[0])">
                </div>

                <div class="form-group mt-3">
                    <label>نوع البيانات:</label>
                    <select class="form-control" id="importDataType">
                        <option value="students">طلاب</option>
                        <option value="halls">قاعات</option>
                        <option value="monitors">مراقبون</option>
                    </select>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>تنسيق ملف الطلاب:</strong> يجب أن يحتوي على الأعمدة التالية: الرقم الجامعي، اسم الطالب، القسم، المرحلة
                </div>
            </div>
            <div class="modal-footer" style="padding: 1rem; border-top: 1px solid #eee; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="hideModal('importExcelModal')">إلغاء</button>
                <button class="btn btn-primary" onclick="processExcelImport()" id="importBtn" disabled>استيراد البيانات</button>
            </div>
        </div>
    </div>

    <!-- نموذج استيراد JSON -->
    <div class="modal" id="importJSONModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">استيراد بيانات من JSON</h3>
                <button class="modal-close" onclick="hideModal('importJSONModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="drop-zone" id="jsonDropZone" onclick="document.getElementById('jsonFileInput').click()">
                    <i class="fas fa-file-code"></i>
                    <h4>اسحب وأفلت ملف JSON هنا</h4>
                    <p>أو انقر لاختيار ملف</p>
                    <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="handleJSONFileSelect(this.files[0])">
                </div>

                <div class="form-group mt-3">
                    <label>نوع البيانات المراد استيرادها:</label>
                    <select class="form-control" id="jsonImportType">
                        <option value="all">كل البيانات (استبدال كامل)</option>
                        <option value="students">طلاب فقط</option>
                        <option value="halls">قاعات فقط</option>
                        <option value="monitors">مراقبون فقط</option>
                    </select>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>ملاحظة:</strong> ملف JSON يجب أن يكون بنفس تنسيق النظام.
                </div>

                <div id="jsonPreview" style="display: none; max-height: 150px; overflow-y: auto; background: #f5f5f5; padding: 1rem; border-radius: 5px; margin-top: 1rem; font-size: 0.9rem;">
                    <h5>معاينة البيانات:</h5>
                    <pre id="jsonPreviewContent"></pre>
                </div>
            </div>
            <div class="modal-footer" style="padding: 1rem; border-top: 1px solid #eee; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="hideModal('importJSONModal')">إلغاء</button>
                <button class="btn btn-primary" onclick="processJSONImport()" id="jsonImportBtn" disabled>استيراد JSON</button>
            </div>
        </div>
    </div>

    <!-- نموذج إعادة ضبط النظام -->
    <div class="modal" id="resetSystemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">⚠️ تصفير النظام</h3>
                <button class="modal-close" onclick="hideModal('resetSystemModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>تحذير:</strong> هذا الإجراء سيحذف جميع البيانات بشكل نهائي!
                </div>

                <div class="form-group mt-3">
                    <label>أدخل كلمة مرور الإدارة للتأكيد:</label>
                    <input type="password" class="form-control" id="resetPassword" placeholder="كلمة المرور" value="admin">
                </div>

                <div class="form-group mt-3">
                    <label>تأكيد العملية:</label>
                    <div>
                        <input type="checkbox" id="confirmReset" onchange="document.getElementById('resetBtn').disabled = !this.checked">
                        <label for="confirmReset">أؤكد أني أريد حذف جميع البيانات وإعادة النظام للحالة المصنعية</label>
                    </div>
                </div>

                <div class="mt-4">
                    <h5>البيانات التي سيتم حذفها:</h5>
                    <ul style="padding-right: 1rem;">
                        <li>جميع بيانات الطلاب</li>
                        <li>جميع بيانات القاعات</li>
                        <li>جميع بيانات المراقبين</li>
                        <li>جميع الخرائط والتوزيعات</li>
                        <li>جميع التقارير</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer" style="padding: 1rem; border-top: 1px solid #eee; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="hideModal('resetSystemModal')">إلغاء</button>
                <button class="btn btn-danger" onclick="confirmSystemReset()" id="resetBtn" disabled>تصفير النظام</button>
            </div>
        </div>
    </div>

    <!-- JavaScript الكامل -->
    <script>
        // ===== بيانات النظام (نظام فارغ) =====
        let systemData = {
            // بيانات النظام الأساسية
            settings: {
                systemName: "مسار القانون",
                centerName: "مركز أورنمو",
                version: "1.0",
                adminPassword: "admin"
            },
            
            // الأقسام الأكاديمية
            departments: [],
            
            // المراحل الدراسية
            stages: [],
            
            // المواد الدراسية
            subjects: [],
            
            // بيانات الطلاب
            students: [],
            
            // بيانات القاعات
            halls: [],
            
            // بيانات المراقبين
            monitors: [],
            
            // النسخ الاحتياطية
            backups: []
        };

        // ===== تهيئة النظام =====
        document.addEventListener('DOMContentLoaded', function() {
            initSystem();
        });

        function initSystem() {
            // تحميل بيانات النظام من التخزين المحلي
            loadSystemData();
            
            // إعداد معالجات الأحداث
            setupEventListeners();
            
            // تحديث الإحصائيات
            updateDashboardStats();
            
            // تحديث المرشحات
            updateFilters();
            
            // إعداد منطقة سحب وإفلات JSON
            setupJSONDropZone();
            
            // إضافة بعض البيانات التجريبية للاختبار
            setTimeout(addSampleData, 1000);
        }

        function loadSystemData() {
            const savedData = localStorage.getItem('lawPathSystemData');
            if (savedData) {
                try {
                    systemData = JSON.parse(savedData);
                    console.log('تم تحميل بيانات النظام بنجاح');
                } catch (e) {
                    console.error('خطأ في تحميل البيانات:', e);
                    showAlert('خطأ في تحميل البيانات، سيتم استخدام النظام الفارغ', 'error');
                }
            }
        }

        function saveSystemData() {
            try {
                localStorage.setItem('lawPathSystemData', JSON.stringify(systemData));
                updateDashboardStats();
                updateFilters();
            } catch (e) {
                console.error('خطأ في حفظ البيانات:', e);
                showAlert('حدث خطأ في حفظ البيانات', 'error');
            }
        }

        // ===== إدارة القائمة الجانبية للهاتف =====
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const menuBtn = document.getElementById('mobileMenuBtn');
            
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                menuBtn.classList.remove('active');
            } else {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                menuBtn.classList.add('active');
            }
        }

        // ===== إدارة الأحداث =====
        function setupEventListeners() {
            // نموذج تسجيل الدخول
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });

            // إعداد منطقة سحب وإفلات الملفات
            setupFileDrop();
            
            // تحديث تأكيد إعادة الضبط
            const confirmReset = document.getElementById('confirmReset');
            if (confirmReset) {
                confirmReset.addEventListener('change', function() {
                    const resetBtn = document.getElementById('resetBtn');
                    if (resetBtn) {
                        resetBtn.disabled = !this.checked;
                    }
                });
            }

            // إغلاق القائمة عند النقر خارجها على الشاشات الصغيرة
            document.addEventListener('click', function(event) {
                const sidebar = document.getElementById('sidebar');
                const menuBtn = document.getElementById('mobileMenuBtn');
                const overlay = document.getElementById('sidebarOverlay');
                
                if (window.innerWidth <= 768 && sidebar.classList.contains('active')) {
                    if (!sidebar.contains(event.target) && !menuBtn.contains(event.target)) {
                        toggleMobileMenu();
                    }
                }
            });

            // إغلاق القائمة عند تغيير حجم النافذة
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('sidebarOverlay');
                    const menuBtn = document.getElementById('mobileMenuBtn');
                    
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                    menuBtn.classList.remove('active');
                }
            });

            // الحفظ التلقائي
            setInterval(saveSystemData, 30000);
        }

        function setupJSONDropZone() {
            const dropZone = document.getElementById('jsonDropZone');
            if (!dropZone) return;

            ['dragover', 'dragenter'].forEach(event => {
                dropZone.addEventListener(event, (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = 'var(--success-color)';
                    dropZone.style.backgroundColor = '#f0f9f0';
                });
            });

            ['dragleave', 'drop'].forEach(event => {
                dropZone.addEventListener(event, (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#ddd';
                    dropZone.style.backgroundColor = '';
                });
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleJSONFileSelect(files[0]);
                }
            });
        }

        // ===== تسجيل الدخول =====
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === 'admin') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainContainer').classList.add('show');
                showAlert('مرحباً بكم في نظام مسار القانون - مركز أورنمو', 'success');
            } else {
                showAlert('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
            }
        }

        // ===== عرض الأقسام =====
        function showSection(section) {
            // إغلاق القائمة الجانبية على الهاتف
            if (window.innerWidth <= 768) {
                toggleMobileMenu();
            }
            
            // تحديث القائمة النشطة
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const navLink = document.querySelector(`.nav-link[onclick*="showSection('${section}')"]`);
            if (navLink) {
                navLink.classList.add('active');
            }
            
            // إخفاء جميع الأقسام
            const sections = ['dashboard', 'initial-setup', 'students', 'halls', 'distribution', 'monitoring', 'reports', 'system'];
            sections.forEach(sec => {
                const sectionElement = document.getElementById(sec + 'Section');
                if (sectionElement) {
                    sectionElement.classList.remove('active');
                }
            });

            // عرض القسم المحدد
            const currentSection = document.getElementById(section + 'Section');
            if (currentSection) {
                currentSection.classList.add('active');
            }

            // تحديث العنوان
            updatePageTitle(section);

            // تحديث محتوى القسم
            updateSectionContent(section);
        }

        function updatePageTitle(section) {
            const titles = {
                'dashboard': 'لوحة التحكم الرئيسية',
                'initial-setup': 'الإعدادات الأولية للنظام',
                'students': 'شؤون طلاب القانون',
                'halls': 'إدارة القاعات الامتحانية',
                'distribution': 'توزيع الخرائط الامتحانية',
                'monitoring': 'إدارة المراقبة والمراقبين',
                'reports': 'التقارير والإحصائيات',
                'system': 'النظام والصيانة'
            };
            
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                pageTitle.textContent = titles[section] || 'مسار القانون';
            }
        }

        function updateSectionContent(section) {
            switch(section) {
                case 'initial-setup':
                    updateInitialSetupStats();
                    break;
                case 'students':
                    updateStudentsTable();
                    break;
                case 'halls':
                    updateHallsTable();
                    updateHallsStats();
                    break;
                case 'distribution':
                    updateDistributionAlert();
                    generateSeatMaps();
                    break;
                case 'monitoring':
                    updateMonitorsTable();
                    break;
                case 'reports':
                    updateReportStats();
                    generateCharts();
                    break;
                case 'system':
                    updateSystemInfo();
                    break;
            }
        }

        // ===== تحديث الإحصائيات =====
        function updateDashboardStats() {
            // إجمالي الطلاب
            const studentCount = systemData.students.length;
            updateElementText('totalStudents', studentCount);
            updateElementText('dashboardStudentCount', studentCount + ' طالب');
            updateElementText('initialStudentCount', studentCount);
            updateElementText('reportStudentCount', studentCount);
            
            // إجمالي القاعات
            const hallCount = systemData.halls.length;
            updateElementText('totalHalls', hallCount);
            updateElementText('dashboardHallCount', hallCount + ' قاعة');
            updateElementText('reportHallCount', hallCount);
            
            // إجمالي المقاعد
            const totalSeats = systemData.halls.reduce((sum, hall) => sum + hall.capacity, 0);
            updateElementText('totalSeats', totalSeats);
            
            // الطلاب الموزعين
            const distributedStudents = systemData.students.filter(student => student.hallId).length;
            updateElementText('distributedStudents', distributedStudents);
            
            // تحديث الأقسام والمراحل والمواد
            updateElementText('deptCount', systemData.departments.length);
            updateElementText('stageCount', systemData.stages.length);
            updateElementText('subjectCount', systemData.subjects.length);
            
            // عدد المراقبين
            updateElementText('reportMonitorCount', systemData.monitors.length);
        }

        function updateElementText(id, text) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = text;
            }
        }

        function updateHallsStats() {
            const totalSeats = systemData.halls.reduce((sum, hall) => sum + hall.capacity, 0);
            const occupiedSeats = systemData.halls.reduce((sum, hall) => sum + (hall.occupied || 0), 0);
            const availableSeats = totalSeats - occupiedSeats;
            const occupancyRate = totalSeats > 0 ? Math.round((occupiedSeats / totalSeats) * 100) : 0;
            const fullHalls = systemData.halls.filter(hall => hall.occupied >= hall.capacity).length;
            
            updateElementText('availableSeats', availableSeats);
            updateElementText('occupiedSeatsStat', occupiedSeats);
            updateElementText('occupancyRate', occupancyRate + '%');
            updateElementText('warningHalls', fullHalls);
            updateElementText('reportOccupancy', occupancyRate + '%');
        }

        function updateInitialSetupStats() {
            updateElementText('deptCount', systemData.departments.length);
            updateElementText('stageCount', systemData.stages.length);
            updateElementText('subjectCount', systemData.subjects.length);
            updateElementText('initialStudentCount', systemData.students.length);
        }

        function updateSystemInfo() {
            const dataSize = JSON.stringify(systemData).length / 1024;
            updateElementText('dataSize', dataSize.toFixed(2) + ' KB');
        }

        // ===== تحديث المرشحات =====
        function updateFilters() {
            const deptFilter = document.getElementById('studentDeptFilter');
            const stageFilter = document.getElementById('studentStageFilter');
            
            if (deptFilter) {
                // تحديث مرشح الأقسام
                deptFilter.innerHTML = '<option value="all">جميع الأقسام</option>';
                systemData.departments.forEach(dept => {
                    deptFilter.innerHTML += `<option value="${dept.id}">${dept.name}</option>`;
                });
            }
            
            if (stageFilter) {
                // تحديث مرشح المراحل
                stageFilter.innerHTML = '<option value="all">جميع المراحل</option>';
                systemData.stages.forEach(stage => {
                    stageFilter.innerHTML += `<option value="${stage.id}">${stage.name}</option>`;
                });
            }
        }

        // ===== إدارة الطلاب =====
        function updateStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (systemData.students.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        لا توجد بيانات طلاب. الرجاء إضافة طلاب من خلال الإعدادات الأولية.
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            systemData.students.forEach((student, index) => {
                const dept = systemData.departments.find(d => d.id === student.departmentId);
                const stage = systemData.stages.find(s => s.id === student.stageId);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td>${dept ? dept.name : 'غير محدد'}</td>
                    <td>${stage ? stage.name : 'غير محدد'}</td>
                    <td>
                        <span class="status-badge ${student.hallId ? 'status-active' : 'status-warning'}">
                            ${student.hallId ? 'موزع' : 'غير موزع'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editStudent('${student.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch')?.value || '';
            const deptFilter = document.getElementById('studentDeptFilter')?.value || 'all';
            const stageFilter = document.getElementById('studentStageFilter')?.value || 'all';
            
            const filtered = systemData.students.filter(student => {
                // البحث بالاسم أو الرقم الجامعي
                const matchesSearch = !searchTerm || 
                    student.name.includes(searchTerm) || 
                    student.id.includes(searchTerm);
                
                // التصفية بالقسم
                const matchesDept = deptFilter === 'all' || student.departmentId == deptFilter;
                
                // التصفية بالمرحلة
                const matchesStage = stageFilter === 'all' || student.stageId == stageFilter;
                
                return matchesSearch && matchesDept && matchesStage;
            });
            
            const tbody = document.getElementById('studentsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (filtered.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                        لا توجد نتائج مطابقة للبحث
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            filtered.forEach((student, index) => {
                const dept = systemData.departments.find(d => d.id === student.departmentId);
                const stage = systemData.stages.find(s => s.id === student.stageId);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td>${dept ? dept.name : 'غير محدد'}</td>
                    <td>${stage ? stage.name : 'غير محدد'}</td>
                    <td>
                        <span class="status-badge ${student.hallId ? 'status-active' : 'status-warning'}">
                            ${student.hallId ? 'موزع' : 'غير موزع'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editStudent('${student.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function addStudent() {
            const name = prompt('اسم الطالب:');
            if (!name || !name.trim()) {
                showAlert('يجب إدخال اسم الطالب', 'warning');
                return;
            }
            
            const id = prompt('الرقم الجامعي:');
            if (!id || !id.trim()) {
                showAlert('يجب إدخال الرقم الجامعي', 'warning');
                return;
            }
            
            // التحقق من عدم تكرار الرقم الجامعي
            if (systemData.students.some(s => s.id === id)) {
                showAlert('الرقم الجامعي موجود بالفعل', 'error');
                return;
            }
            
            systemData.students.push({
                id: id.trim(),
                name: name.trim(),
                departmentId: null,
                stageId: null,
                subjectId: null,
                hallId: null,
                seatNumber: null
            });
            
            saveSystemData();
            updateStudentsTable();
            showAlert('تم إضافة الطالب بنجاح', 'success');
        }

        function editStudent(studentId) {
            const student = systemData.students.find(s => s.id === studentId);
            if (!student) {
                showAlert('الطالب غير موجود', 'error');
                return;
            }
            
            const newName = prompt('اسم الطالب الجديد:', student.name);
            if (newName && newName.trim() !== '') {
                student.name = newName.trim();
                saveSystemData();
                updateStudentsTable();
                showAlert('تم تعديل بيانات الطالب بنجاح', 'success');
            }
        }

        function deleteStudent(studentId) {
            if (!confirm('هل تريد حذف هذا الطالب؟')) return;
            
            systemData.students = systemData.students.filter(s => s.id !== studentId);
            saveSystemData();
            updateStudentsTable();
            updateDashboardStats();
            showAlert('تم حذف الطالب بنجاح', 'success');
        }

        // ===== إدارة القاعات =====
        function updateHallsTable() {
            const tbody = document.getElementById('hallsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (systemData.halls.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        لا توجد قاعات مضافة. الرجاء إضافة قاعات أولاً.
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            systemData.halls.forEach((hall, index) => {
                const occupied = hall.occupied || 0;
                const available = hall.capacity - occupied;
                const status = occupied >= hall.capacity ? 'ممتلئة' : 'متاحة';
                const statusClass = occupied >= hall.capacity ? 'status-warning' : 'status-active';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${hall.name}</td>
                    <td>${hall.capacity}</td>
                    <td>${occupied}</td>
                    <td>${available}</td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editHall('${hall.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function addHall() {
            const name = prompt('اسم القاعة:');
            if (!name || !name.trim()) {
                showAlert('يجب إدخال اسم القاعة', 'warning');
                return;
            }
            
            const capacity = prompt('سعة القاعة:', '30');
            if (!capacity || isNaN(capacity) || parseInt(capacity) <= 0) {
                showAlert('يجب إدخال سعة صحيحة للقاعة', 'warning');
                return;
            }
            
            const hallId = 'H' + Date.now() + Math.random().toString(36).substr(2, 9);
            
            systemData.halls.push({
                id: hallId,
                name: name.trim(),
                capacity: parseInt(capacity),
                occupied: 0
            });
            
            saveSystemData();
            updateHallsTable();
            updateHallsStats();
            showAlert('تم إضافة القاعة بنجاح', 'success');
        }

        function editHall(hallId) {
            const hall = systemData.halls.find(h => h.id === hallId);
            if (!hall) {
                showAlert('القاعة غير موجودة', 'error');
                return;
            }
            
            const newName = prompt('اسم القاعة الجديد:', hall.name);
            if (!newName || !newName.trim()) {
                showAlert('يجب إدخال اسم القاعة', 'warning');
                return;
            }
            
            const newCapacity = prompt('السعة الجديدة:', hall.capacity);
            if (!newCapacity || isNaN(newCapacity) || parseInt(newCapacity) <= 0) {
                showAlert('يجب إدخال سعة صحيحة', 'warning');
                return;
            }
            
            hall.name = newName.trim();
            hall.capacity = parseInt(newCapacity);
            
            saveSystemData();
            updateHallsTable();
            updateHallsStats();
            showAlert('تم تعديل بيانات القاعة بنجاح', 'success');
        }

        // ===== توزيع الخرائط =====
        function updateDistributionAlert() {
            const alertDiv = document.getElementById('distributionAlert');
            if (!alertDiv) return;
            
            if (systemData.students.length === 0 || systemData.halls.length === 0) {
                alertDiv.style.display = 'flex';
                if (systemData.students.length === 0) {
                    alertDiv.querySelector('strong').textContent = 'لا يوجد طلاب!';
                    alertDiv.querySelector('span').innerHTML = 'الرجاء إضافة طلاب أولاً من قسم شؤون الطلاب.';
                } else {
                    alertDiv.querySelector('strong').textContent = 'لا توجد قاعات!';
                    alertDiv.querySelector('span').innerHTML = 'الرجاء إضافة قاعات أولاً من قسم إدارة القاعات.';
                }
            } else {
                alertDiv.style.display = 'none';
            }
        }

        function generateSeatMaps() {
            const container = document.getElementById('seatMapsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (systemData.halls.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-map" style="font-size: 2.5rem; margin-bottom: 1rem; display: block;"></i>
                        <h3>لا توجد خرائط لعرضها</h3>
                        <p>الرجاء إضافة قاعات أولاً ثم توزيع الطلاب عليها</p>
                    </div>
                `;
                return;
            }
            
            systemData.halls.forEach(hall => {
                const hallStudents = systemData.students.filter(s => s.hallId === hall.id);
                const seatMap = document.createElement('div');
                seatMap.className = 'seat-map';
                seatMap.innerHTML = `
                    <div class="seat-map-header">
                        <div class="seat-map-title">${hall.name}</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">
                            ${hallStudents.length}/${hall.capacity} طالب
                        </div>
                    </div>
                    <div class="seats-grid" id="seats-${hall.id}">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </div>
                `;
                container.appendChild(seatMap);
                
                // توليد المقاعد
                const seatsGrid = document.getElementById(`seats-${hall.id}`);
                if (!seatsGrid) return;
                
                for (let i = 1; i <= hall.capacity; i++) {
                    const seat = document.createElement('div');
                    seat.className = 'seat empty';
                    seat.dataset.seatNumber = i;
                    seat.dataset.hallId = hall.id;
                    
                    const student = hallStudents[i - 1];
                    if (student) {
                        seat.className = 'seat occupied';
                        seat.innerHTML = `
                            <div class="student-name">${student.name.split(' ')[0]}</div>
                            <div class="student-id">${student.id}</div>
                            <div style="font-size: 0.65rem; color: #666; margin-top: 3px;">مقعد ${i}</div>
                        `;
                        seat.onclick = () => removeStudentFromSeat(student.id);
                    } else {
                        seat.innerHTML = `
                            <div style="color: #999; font-size: 0.85rem;">مقعد ${i}</div>
                            <div style="color: #ccc; font-size: 0.65rem;">فارغ</div>
                        `;
                        seat.onclick = () => assignStudentToSeat(hall.id, i);
                    }
                    
                    seatsGrid.appendChild(seat);
                }
            });
        }

        function manualDistribution() {
            if (systemData.students.length === 0 || systemData.halls.length === 0) {
                showAlert('الرجاء إضافة طلاب وقاعات أولاً', 'warning');
                return;
            }
            
            showAlert('تم تفعيل وضع التوزيع اليدوي. انقر على مقعد فارغ لإضافة طالب، أو على مقعد مشغول لإزالة الطالب.', 'info');
            generateSeatMaps();
        }

        function assignStudentToSeat(hallId, seatNumber) {
            // العثور على طالب غير موزع
            const unassignedStudent = systemData.students.find(s => !s.hallId);
            
            if (!unassignedStudent) {
                showAlert('لا يوجد طلاب غير موزعين', 'warning');
                return;
            }
            
            // التحقق من أن المقعد غير مشغول بالفعل
            const hall = systemData.halls.find(h => h.id === hallId);
            if (!hall) {
                showAlert('القاعة غير موجودة', 'error');
                return;
            }
            
            const hallStudents = systemData.students.filter(s => s.hallId === hallId);
            
            if (hallStudents.length >= hall.capacity) {
                showAlert('القاعة ممتلئة', 'warning');
                return;
            }
            
            // التحقق من أن المقعد غير مشغول
            const seatOccupied = hallStudents.some(s => s.seatNumber === seatNumber);
            if (seatOccupied) {
                showAlert('هذا المقعد مشغول بالفعل', 'warning');
                return;
            }
            
            // توزيع الطالب
            unassignedStudent.hallId = hallId;
            unassignedStudent.seatNumber = seatNumber;
            hall.occupied = (hall.occupied || 0) + 1;
            
            saveSystemData();
            generateSeatMaps();
            updateDashboardStats();
            updateHallsStats();
            updateStudentsTable();
            
            showAlert(`تم توزيع ${unassignedStudent.name} على ${hall.name} - مقعد ${seatNumber}`, 'success');
        }

        function removeStudentFromSeat(studentId) {
            const student = systemData.students.find(s => s.id === studentId);
            if (!student || !student.hallId) {
                showAlert('الطالب غير موزع', 'warning');
                return;
            }
            
            const hall = systemData.halls.find(h => h.id === student.hallId);
            if (hall) {
                hall.occupied = Math.max(0, (hall.occupied || 0) - 1);
            }
            
            student.hallId = null;
            student.seatNumber = null;
            
            saveSystemData();
            generateSeatMaps();
            updateDashboardStats();
            updateHallsStats();
            updateStudentsTable();
            
            showAlert(`تم إزالة ${student.name} من التوزيع`, 'success');
        }

        function autoDistribution(type = 'alphabetical') {
            if (systemData.students.length === 0 || systemData.halls.length === 0) {
                showAlert('الرجاء إضافة طلاب وقاعات أولاً', 'warning');
                return;
            }
            
            showLoading();
            
            // إعادة تعيين جميع التوزيعات
            systemData.students.forEach(student => {
                student.hallId = null;
                student.seatNumber = null;
            });
            
            systemData.halls.forEach(hall => {
                hall.occupied = 0;
            });
            
            // فرز الطلاب حسب النوع المطلوب
            let studentsToDistribute = [...systemData.students];
            if (type === 'alphabetical') {
                studentsToDistribute.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            } else if (type === 'random') {
                studentsToDistribute = shuffleArray(studentsToDistribute);
            }
            
            // توزيع الطلاب على القاعات
            const halls = [...systemData.halls];
            let hallIndex = 0;
            let seatNumber = 1;
            
            // التحقق من سعة القاعات
            const totalCapacity = halls.reduce((sum, hall) => sum + hall.capacity, 0);
            if (studentsToDistribute.length > totalCapacity) {
                hideLoading();
                showAlert(`عدد الطلاب (${studentsToDistribute.length}) أكبر من سعة القاعات (${totalCapacity})!`, 'error');
                return;
            }
            
            studentsToDistribute.forEach(student => {
                let hall = halls[hallIndex];
                
                // البحث عن قاعة بها مقاعد متاحة
                while (hall && (hall.occupied || 0) >= hall.capacity) {
                    hallIndex = (hallIndex + 1) % halls.length;
                    hall = halls[hallIndex];
                    seatNumber = 1;
                }
                
                // توزيع الطالب
                student.hallId = hall.id;
                student.seatNumber = seatNumber;
                hall.occupied = (hall.occupied || 0) + 1;
                seatNumber++;
                
                // الانتقال للقاعة التالية إذا امتلأت
                if (seatNumber > hall.capacity) {
                    hallIndex = (hallIndex + 1) % halls.length;
                    seatNumber = 1;
                }
            });
            
            setTimeout(() => {
                hideLoading();
                saveSystemData();
                generateSeatMaps();
                updateDashboardStats();
                updateHallsStats();
                updateStudentsTable();
                showAlert(`تم توزيع ${studentsToDistribute.length} طالب بنجاح (${type === 'alphabetical' ? 'ترتيب أبجدي' : 'عشوائي'})`, 'success');
            }, 1000);
        }

        function clearDistribution() {
            if (!confirm('هل تريد مسح جميع التوزيعات؟')) return;
            
            systemData.students.forEach(student => {
                student.hallId = null;
                student.seatNumber = null;
            });
            
            systemData.halls.forEach(hall => {
                hall.occupied = 0;
            });
            
            saveSystemData();
            generateSeatMaps();
            updateDashboardStats();
            updateHallsStats();
            updateStudentsTable();
            showAlert('تم مسح جميع التوزيعات', 'success');
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // ===== إدارة المراقبين =====
        function updateMonitorsTable() {
            const tbody = document.getElementById('monitorsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (systemData.monitors.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        لا توجد بيانات مراقبين. الرجاء إضافة مراقبين أولاً.
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            systemData.monitors.forEach((monitor, index) => {
                const halls = monitor.halls || [];
                const hallCount = halls.length;
                const studentCount = halls.reduce((count, hallId) => {
                    const hallStudents = systemData.students.filter(s => s.hallId === hallId).length;
                    return count + hallStudents;
                }, 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${monitor.name}</td>
                    <td>${monitor.phone || 'غير محدد'}</td>
                    <td>${hallCount}</td>
                    <td>${studentCount}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editMonitor('${monitor.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-info btn-sm" onclick="assignHallsToMonitor('${monitor.id}')">
                            <i class="fas fa-tasks"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function addMonitor() {
            const name = prompt('اسم المراقب:');
            if (!name || !name.trim()) {
                showAlert('يجب إدخال اسم المراقب', 'warning');
                return;
            }
            
            const phone = prompt('رقم الهاتف (اختياري):') || '';
            
            const monitorId = 'M' + Date.now() + Math.random().toString(36).substr(2, 9);
            
            systemData.monitors.push({
                id: monitorId,
                name: name.trim(),
                phone: phone,
                halls: []
            });
            
            saveSystemData();
            updateMonitorsTable();
            showAlert('تم إضافة المراقب بنجاح', 'success');
        }

        function editMonitor(monitorId) {
            const monitor = systemData.monitors.find(m => m.id === monitorId);
            if (!monitor) {
                showAlert('المراقب غير موجود', 'error');
                return;
            }
            
            const newName = prompt('اسم المراقب الجديد:', monitor.name);
            if (newName && newName.trim() !== '') {
                monitor.name = newName.trim();
                
                const newPhone = prompt('رقم الهاتف الجديد:', monitor.phone);
                monitor.phone = newPhone || '';
                
                saveSystemData();
                updateMonitorsTable();
                showAlert('تم تعديل بيانات المراقب بنجاح', 'success');
            }
        }

        function assignHallsToMonitor(monitorId) {
            const monitor = systemData.monitors.find(m => m.id === monitorId);
            if (!monitor) {
                showAlert('المراقب غير موجود', 'error');
                return;
            }
            
            if (systemData.halls.length === 0) {
                showAlert('لا توجد قاعات متاحة للتوزيع', 'warning');
                return;
            }
            
            let message = 'اختر القاعات المراد تخصيصها لهذا المراقب:\n';
            systemData.halls.forEach((hall, index) => {
                const isAssigned = monitor.halls.includes(hall.id);
                message += `${index + 1}. ${hall.name} ${isAssigned ? '✓' : ''}\n`;
            });
            
            const selection = prompt(message + '\nأدخل أرقام القاعات مفصولة بفواصل (مثال: 1,3,5):');
            if (!selection) return;
            
            const selectedIndices = selection.split(',').map(num => parseInt(num.trim()) - 1).filter(num => !isNaN(num) && num >= 0 && num < systemData.halls.length);
            
            monitor.halls = selectedIndices.map(index => systemData.halls[index].id);
            
            saveSystemData();
            updateMonitorsTable();
            showAlert('تم تخصيص القاعات للمراقب بنجاح', 'success');
        }

        function assignMonitorsAuto() {
            if (systemData.monitors.length === 0) {
                showAlert('الرجاء إضافة مراقبين أولاً', 'warning');
                return;
            }
            
            if (systemData.halls.length === 0) {
                showAlert('الرجاء إضافة قاعات أولاً', 'warning');
                return;
            }
            
            // إعادة تعيين القاعات للمراقبين
            systemData.monitors.forEach(monitor => {
                monitor.halls = [];
            });
            
            // توزيع القاعات على المراقبين بالتساوي
            const hallsPerMonitor = Math.ceil(systemData.halls.length / systemData.monitors.length);
            
            systemData.monitors.forEach((monitor, index) => {
                const startIndex = index * hallsPerMonitor;
                const endIndex = Math.min(startIndex + hallsPerMonitor, systemData.halls.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    monitor.halls.push(systemData.halls[i].id);
                }
            });
            
            saveSystemData();
            updateMonitorsTable();
            showAlert('تم توزيع القاعات على المراقبين تلقائياً', 'success');
        }

        // ===== الإعدادات الأولية =====
        function addDepartment() {
            const name = prompt('اسم القسم:');
            if (!name || !name.trim()) {
                showAlert('يجب إدخال اسم القسم', 'warning');
                return;
            }
            
            const code = prompt('رمز القسم (اختصار):', name.substring(0, 3).toUpperCase());
            if (!code || !code.trim()) {
                showAlert('يجب إدخال رمز القسم', 'warning');
                return;
            }
            
            const deptId = 'DEPT' + Date.now();
            
            systemData.departments.push({
                id: deptId,
                name: name.trim(),
                code: code.trim().toUpperCase()
            });
            
            saveSystemData();
            updateDashboardStats();
            updateFilters();
            showAlert('تم إضافة القسم بنجاح', 'success');
        }

        function addStage() {
            const name = prompt('اسم المرحلة (مثال: المرحلة الأولى):');
            if (!name || !name.trim()) {
                showAlert('يجب إدخال اسم المرحلة', 'warning');
                return;
            }
            
            const level = prompt('مستوى المرحلة (رقم من 1 إلى 4):', '1');
            if (!level || isNaN(level) || parseInt(level) < 1 || parseInt(level) > 4) {
                showAlert('يجب إدخال مستوى صحيح بين 1 و 4', 'warning');
                return;
            }
            
            const stageId = 'STAGE' + level;
            
            // التحقق من عدم تكرار المرحلة
            if (systemData.stages.some(s => s.id === stageId)) {
                showAlert('المرحلة موجودة بالفعل', 'error');
                return;
            }
            
            systemData.stages.push({
                id: stageId,
                name: name.trim(),
                level: parseInt(level)
            });
            
            saveSystemData();
            updateDashboardStats();
            updateFilters();
            showAlert('تم إضافة المرحلة بنجاح', 'success');
        }

        function addSubject() {
            const name = prompt('اسم المادة الدراسية:');
            if (!name || !name.trim()) {
                showAlert('يجب إدخال اسم المادة', 'warning');
                return;
            }
            
            const code = prompt('رمز المادة (اختصار):', name.substring(0, 4).toUpperCase());
            if (!code || !code.trim()) {
                showAlert('يجب إدخال رمز المادة', 'warning');
                return;
            }
            
            const subjectId = 'SUBJ' + Date.now();
            
            systemData.subjects.push({
                id: subjectId,
                name: name.trim(),
                code: code.trim().toUpperCase()
            });
            
            saveSystemData();
            updateDashboardStats();
            showAlert('تم إضافة المادة الدراسية بنجاح', 'success');
        }

        // ===== الرسوم البيانية =====
        function generateCharts() {
            // توزيع الطلاب حسب الأقسام
            const deptCtx = document.getElementById('departmentChart');
            if (!deptCtx) return;
            
            // إزالة الرسم البياني السابق إذا كان موجوداً
            if (window.departmentChart) {
                window.departmentChart.destroy();
            }
            
            const deptData = {};
            
            systemData.students.forEach(student => {
                const dept = systemData.departments.find(d => d.id === student.departmentId);
                const deptName = dept ? dept.name : 'غير محدد';
                deptData[deptName] = (deptData[deptName] || 0) + 1;
            });
            
            if (Object.keys(deptData).length > 0) {
                window.departmentChart = new Chart(deptCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(deptData),
                        datasets: [{
                            label: 'عدد الطلاب',
                            data: Object.values(deptData),
                            backgroundColor: 'rgba(26, 35, 126, 0.7)',
                            borderColor: 'rgba(26, 35, 126, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // توزيع الطلاب حسب المراحل
            const stageCtx = document.getElementById('stageChart');
            if (!stageCtx) return;
            
            // إزالة الرسم البياني السابق إذا كان موجوداً
            if (window.stageChart) {
                window.stageChart.destroy();
            }
            
            const stageData = {};
            
            systemData.students.forEach(student => {
                const stage = systemData.stages.find(s => s.id === student.stageId);
                const stageName = stage ? stage.name : 'غير محدد';
                stageData[stageName] = (stageData[stageName] || 0) + 1;
            });
            
            if (Object.keys(stageData).length > 0) {
                window.stageChart = new Chart(stageCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(stageData),
                        datasets: [{
                            data: Object.values(stageData),
                            backgroundColor: [
                                'rgba(26, 35, 126, 0.7)',
                                'rgba(40, 53, 147, 0.7)',
                                'rgba(57, 73, 171, 0.7)',
                                'rgba(92, 107, 192, 0.7)',
                                'rgba(121, 134, 203, 0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        // ===== إدارة الملفات Excel =====
        function setupFileDrop() {
            const dropZone = document.getElementById('excelDropZone');
            if (!dropZone) return;

            ['dragover', 'dragenter'].forEach(event => {
                dropZone.addEventListener(event, (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = 'var(--success-color)';
                    dropZone.style.backgroundColor = '#f0f9f0';
                });
            });

            ['dragleave', 'drop'].forEach(event => {
                dropZone.addEventListener(event, (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#ddd';
                    dropZone.style.backgroundColor = '';
                });
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });
        }

        function showImportModal(type) {
            const importDataType = document.getElementById('importDataType');
            if (importDataType) {
                importDataType.value = type;
            }
            showModal('importExcelModal');
        }

        function handleFileSelect(file) {
            if (!file) return;
            
            const fileName = file.name.toLowerCase();
            
            if (!fileName.match(/\.(xlsx|xls|csv)$/)) {
                showAlert('يرجى اختيار ملف Excel صالح (xlsx, xls, csv)', 'error');
                return;
            }

            showAlert(`تم تحديد الملف: ${file.name}`, 'success');
            const importBtn = document.getElementById('importBtn');
            if (importBtn) {
                importBtn.disabled = false;
            }
            
            // حفظ الملف مؤقتاً
            window.selectedFile = file;
        }

        function processExcelImport() {
            const importType = document.getElementById('importDataType')?.value;
            const file = window.selectedFile;
            
            if (!file) {
                showAlert('لم يتم اختيار ملف', 'error');
                return;
            }
            
            showLoading();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    let jsonData;
                    
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        jsonData = parseCSV(data);
                    } else {
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    }
                    
                    processImportedData(jsonData, importType);
                } catch (error) {
                    console.error('خطأ في قراءة الملف:', error);
                    hideLoading();
                    showAlert('حدث خطأ في قراءة ملف Excel', 'error');
                }
            };
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(',').map(h => h.trim());
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const obj = {};
                const currentLine = lines[i].split(',');
                
                headers.forEach((header, index) => {
                    obj[header] = currentLine[index] ? currentLine[index].trim() : '';
                });
                
                result.push(obj);
            }
            
            return result;
        }

        function processImportedData(data, type) {
            let count = 0;
            
            if (type === 'students') {
                data.forEach((row, index) => {
                    if (!row['اسم الطالب'] || !row['الرقم الجامعي']) return;
                    
                    const studentId = row['الرقم الجامعي'].toString();
                    
                    // التحقق من عدم وجود طالب بنفس الرقم
                    if (systemData.students.some(s => s.id === studentId)) {
                        // تحديث الطالب الموجود
                        const existingStudent = systemData.students.find(s => s.id === studentId);
                        existingStudent.name = row['اسم الطالب'];
                        count++;
                    } else {
                        // إضافة طالب جديد
                        systemData.students.push({
                            id: studentId,
                            name: row['اسم الطالب'],
                            departmentId: null,
                            stageId: null,
                            subjectId: null,
                            hallId: null,
                            seatNumber: null
                        });
                        count++;
                    }
                });
                
                hideLoading();
                hideModal('importExcelModal');
                saveSystemData();
                updateStudentsTable();
                showAlert(`تم استيراد ${count} طالب`, 'success');
            } else if (type === 'halls') {
                // معالجة استيراد القاعات
                data.forEach(row => {
                    if (!row['اسم القاعة'] || !row['السعة']) return;
                    
                    const hallId = 'H' + Date.now() + Math.random().toString(36).substr(2, 9);
                    
                    systemData.halls.push({
                        id: hallId,
                        name: row['اسم القاعة'],
                        capacity: parseInt(row['السعة']) || 30,
                        occupied: 0
                    });
                    count++;
                });
                
                hideLoading();
                hideModal('importExcelModal');
                saveSystemData();
                updateHallsTable();
                updateHallsStats();
                showAlert(`تم استيراد ${count} قاعة`, 'success');
            } else if (type === 'monitors') {
                // معالجة استيراد المراقبين
                data.forEach(row => {
                    if (!row['اسم المراقب']) return;
                    
                    const monitorId = 'M' + Date.now() + Math.random().toString(36).substr(2, 9);
                    
                    systemData.monitors.push({
                        id: monitorId,
                        name: row['اسم المراقب'],
                        phone: row['رقم الهاتف'] || '',
                        halls: []
                    });
                    count++;
                });
                
                hideLoading();
                hideModal('importExcelModal');
                saveSystemData();
                updateMonitorsTable();
                showAlert(`تم استيراد ${count} مراقب`, 'success');
            }
        }

        // ===== إدارة ملفات JSON =====
        function importJSON(type = 'all') {
            const importType = document.getElementById('jsonImportType');
            
            if (importType) importType.value = type;
            
            showModal('importJSONModal');
        }

        function handleJSONFileSelect(file) {
            if (!file) return;
            
            const fileName = file.name.toLowerCase();
            
            if (!fileName.endsWith('.json')) {
                showAlert('يرجى اختيار ملف JSON صالح', 'error');
                return;
            }

            showAlert(`تم تحديد الملف: ${file.name}`, 'success');
            const importBtn = document.getElementById('jsonImportBtn');
            if (importBtn) {
                importBtn.disabled = false;
            }
            
            // قراءة ومعاينة الملف
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    window.selectedJSONFile = jsonData;
                    
                    // عرض معاينة البيانات
                    const previewDiv = document.getElementById('jsonPreview');
                    const previewContent = document.getElementById('jsonPreviewContent');
                    if (previewDiv && previewContent) {
                        previewDiv.style.display = 'block';
                        previewContent.textContent = JSON.stringify(jsonData, null, 2).substring(0, 1000) + '...';
                    }
                } catch (error) {
                    console.error('خطأ في قراءة ملف JSON:', error);
                    showAlert('ملف JSON غير صالح', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function processJSONImport() {
            const importType = document.getElementById('jsonImportType')?.value || 'all';
            const jsonData = window.selectedJSONFile;
            
            if (!jsonData) {
                showAlert('لم يتم اختيار ملف', 'error');
                return;
            }
            
            showLoading();
            
            try {
                if (importType === 'all') {
                    if (confirm('هل تريد استبدال كامل بيانات النظام؟ سيتم حذف جميع البيانات الحالية.')) {
                        systemData = jsonData;
                        saveSystemData();
                        location.reload();
                        showAlert('تم استبدال كامل بيانات النظام بنجاح', 'success');
                    }
                } else {
                    // استيراد نوع معين من البيانات
                    if (Array.isArray(jsonData[importType]) && Array.isArray(systemData[importType])) {
                        systemData[importType] = [...systemData[importType], ...jsonData[importType]];
                    } else if (typeof jsonData[importType] === 'object' && jsonData[importType] !== null) {
                        systemData[importType] = { ...systemData[importType], ...jsonData[importType] };
                    } else {
                        systemData[importType] = jsonData[importType] || jsonData;
                    }
                    
                    saveSystemData();
                    updateAllTables();
                    showAlert(`تم استيراد بيانات ${getDataTypeName(importType)} بنجاح`, 'success');
                }
            } catch (error) {
                console.error('خطأ في معالجة ملف JSON:', error);
                showAlert('حدث خطأ في معالجة ملف JSON', 'error');
            }
            
            hideLoading();
            hideModal('importJSONModal');
        }

        function exportJSON(type = 'all') {
            let dataToExport;
            let fileName;
            
            switch(type) {
                case 'students':
                    dataToExport = { students: systemData.students };
                    fileName = `طلاب_مسار_القانون_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'halls':
                    dataToExport = { halls: systemData.halls };
                    fileName = `قاعات_مسار_القانون_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'monitors':
                    dataToExport = { monitors: systemData.monitors };
                    fileName = `مراقبون_مسار_القانون_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'settings':
                    dataToExport = { 
                        departments: systemData.departments,
                        stages: systemData.stages,
                        subjects: systemData.subjects
                    };
                    fileName = `إعدادات_مسار_القانون_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'all':
                default:
                    dataToExport = systemData;
                    fileName = `نسخة_كاملة_مسار_القانون_${new Date().toISOString().split('T')[0]}.json`;
                    break;
            }
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showAlert(`تم تصدير ${getDataTypeName(type)} كملف JSON`, 'success');
        }

        function getDataTypeName(type) {
            const names = {
                'students': 'الطلاب',
                'halls': 'القاعات',
                'monitors': 'المراقبين',
                'settings': 'الإعدادات',
                'all': 'جميع البيانات'
            };
            return names[type] || type;
        }

        function updateAllTables() {
            updateStudentsTable();
            updateHallsTable();
            updateMonitorsTable();
            updateDashboardStats();
            updateHallsStats();
            updateFilters();
            generateSeatMaps();
        }

        // ===== التصدير Excel =====
        function exportStudentsExcel() {
            if (systemData.students.length === 0) {
                showAlert('لا توجد بيانات طلاب للتصدير', 'warning');
                return;
            }
            
            try {
                const worksheet = XLSX.utils.json_to_sheet(systemData.students.map(s => ({
                    'الرقم الجامعي': s.id,
                    'اسم الطالب': s.name,
                    'القسم': systemData.departments.find(d => d.id === s.departmentId)?.name || '',
                    'المرحلة': systemData.stages.find(st => st.id === s.stageId)?.name || '',
                    'القاعة': systemData.halls.find(h => h.id === s.hallId)?.name || '',
                    'رقم المقعد': s.seatNumber || ''
                })));
                
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "طلاب القانون");
                XLSX.writeFile(workbook, `طلاب_القانون_مركز_أورنمو_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showAlert('تم تصدير بيانات الطلاب بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في التصدير:', error);
                showAlert('حدث خطأ في تصدير البيانات', 'error');
            }
        }

        function exportReportExcel() {
            if (systemData.students.length === 0 && systemData.halls.length === 0) {
                showAlert('لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            try {
                const workbook = XLSX.utils.book_new();
                
                // ورقة الطلاب
                if (systemData.students.length > 0) {
                    const studentsSheet = XLSX.utils.json_to_sheet(systemData.students.map(s => ({
                        'الرقم الجامعي': s.id,
                        'اسم الطالب': s.name,
                        'القسم': systemData.departments.find(d => d.id === s.departmentId)?.name || '',
                        'المرحلة': systemData.stages.find(st => st.id === s.stageId)?.name || '',
                        'القاعة': systemData.halls.find(h => h.id === s.hallId)?.name || '',
                        'رقم المقعد': s.seatNumber || ''
                    })));
                    XLSX.utils.book_append_sheet(workbook, studentsSheet, "الطلاب");
                }
                
                // ورقة القاعات
                if (systemData.halls.length > 0) {
                    const hallsSheet = XLSX.utils.json_to_sheet(systemData.halls.map(h => ({
                        'اسم القاعة': h.name,
                        'السعة': h.capacity,
                        'المشغول': h.occupied || 0,
                        'المتاح': h.capacity - (h.occupied || 0),
                        'نسبة الإشغال': h.capacity > 0 ? `${Math.round(((h.occupied || 0) / h.capacity) * 100)}%` : '0%'
                    })));
                    XLSX.utils.book_append_sheet(workbook, hallsSheet, "القاعات");
                }
                
                XLSX.writeFile(workbook, `تقرير_مسار_القانون_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showAlert('تم تصدير التقرير الشامل بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في التصدير:', error);
                showAlert('حدث خطأ في تصدير التقرير', 'error');
            }
        }

        // ===== الطباعة والتقارير =====
        function printSectionReport(section) {
            showLoading();
            
            setTimeout(() => {
                hideLoading();
                showAlert('جاري إعداد التقرير للطباعة...', 'info');
                setTimeout(() => {
                    window.print();
                }, 500);
            }, 1000);
        }

        function printDashboardReport() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('ar-SA') + ' ' + now.toLocaleTimeString('ar-SA');
            
            const printContent = `
                <html dir="rtl">
                <head>
                    <title>تقرير لوحة التحكم - مسار القانون</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 20px; direction: rtl; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #d4af37; padding-bottom: 15px; }
                        .title { color: #1a237e; font-size: 24px; margin-bottom: 10px; }
                        .subtitle { color: #3949ab; font-size: 18px; }
                        .date { color: #666; margin-top: 10px; }
                        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
                        .stat-box { background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; border-top: 4px solid #d4af37; }
                        .stat-value { color: #1a237e; font-size: 28px; font-weight: bold; margin: 10px 0; }
                        .stat-label { color: #666; }
                        .section { margin-bottom: 25px; }
                        .section-title { color: #1a237e; font-size: 18px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #eee; }
                        .table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                        .table th { background: #e8eaf6; color: #1a237e; padding: 10px; border: 1px solid #ddd; text-align: right; }
                        .table td { padding: 8px; border: 1px solid #ddd; }
                        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 14px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="title">تقرير لوحة التحكم</div>
                        <div class="subtitle">مركز أورنمو - مسار القانون</div>
                        <div class="date">${dateStr}</div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value">${systemData.students.length}</div>
                            <div class="stat-label">إجمالي الطلاب</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${systemData.halls.length}</div>
                            <div class="stat-label">إجمالي القاعات</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${systemData.halls.reduce((sum, hall) => sum + hall.capacity, 0)}</div>
                            <div class="stat-label">إجمالي المقاعد</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${systemData.students.filter(s => s.hallId).length}</div>
                            <div class="stat-label">طلاب موزعين</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">ملخص النظام</div>
                        <table class="table">
                            <tr><td>عدد الأقسام</td><td>${systemData.departments.length}</td></tr>
                            <tr><td>عدد المراحل</td><td>${systemData.stages.length}</td></tr>
                            <tr><td>عدد المواد</td><td>${systemData.subjects.length}</td></tr>
                            <tr><td>عدد المراقبين</td><td>${systemData.monitors.length}</td></tr>
                        </table>
                    </div>
                    
                    <div class="footer">
                        <div>نظام إدارة الخرائط الامتحانية - مسار القانون</div>
                        <div>مركز أورنمو - الإصدار 1.0</div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
            
            showAlert('تم تحضير تقرير لوحة التحكم للطباعة', 'success');
        }

        function generateFullReport() {
            showAlert('جاري إعداد التقرير الكامل...', 'info');
            
            setTimeout(() => {
                window.print();
                showAlert('جاهز للطباعة', 'success');
            }, 1000);
        }

        function printSystemReport() {
            printSectionReport('system');
        }

        function printSystemInfo() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('ar-SA') + ' ' + now.toLocaleTimeString('ar-SA');
            const dataSize = JSON.stringify(systemData).length / 1024;
            
            const printContent = `
                <html dir="rtl">
                <head>
                    <title>معلومات النظام - مسار القانون</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 20px; direction: rtl; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #d4af37; padding-bottom: 15px; }
                        .title { color: #1a237e; font-size: 24px; margin-bottom: 10px; }
                        .subtitle { color: #3949ab; font-size: 18px; }
                        .date { color: #666; margin-top: 10px; }
                        .info-box { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        .info-title { color: #1a237e; font-size: 18px; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 8px; }
                        .info-row { display: flex; margin-bottom: 10px; }
                        .info-label { width: 200px; font-weight: bold; color: #555; }
                        .info-value { flex: 1; color: #333; }
                        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
                        .stat-box { background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ddd; }
                        .stat-value { color: #1a237e; font-size: 24px; font-weight: bold; margin: 10px 0; }
                        .stat-label { color: #666; }
                        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 14px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="title">معلومات النظام</div>
                        <div class="subtitle">مركز أورنمو - مسار القانون</div>
                        <div class="date">${dateStr}</div>
                    </div>
                    
                    <div class="info-box">
                        <div class="info-title">تفاصيل النظام</div>
                        <div class="info-row"><div class="info-label">اسم النظام:</div><div class="info-value">مسار القانون</div></div>
                        <div class="info-row"><div class="info-label">المؤسسة:</div><div class="info-value">مركز أورنمو</div></div>
                        <div class="info-row"><div class="info-label">الإصدار:</div><div class="info-value">1.0</div></div>
                        <div class="info-row"><div class="info-label">حجم البيانات:</div><div class="info-value">${dataSize.toFixed(2)} KB</div></div>
                        <div class="info-row"><div class="info-label">عدد النسخ الاحتياطية:</div><div class="info-value">${systemData.backups.length}</div></div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value">${systemData.departments.length}</div>
                            <div class="stat-label">الأقسام</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${systemData.stages.length}</div>
                            <div class="stat-label">المراحل</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${systemData.subjects.length}</div>
                            <div class="stat-label">المواد</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${systemData.students.length}</div>
                            <div class="stat-label">الطلاب</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${systemData.halls.length}</div>
                            <div class="stat-label">القاعات</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${systemData.monitors.length}</div>
                            <div class="stat-label">المراقبون</div>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <div>نظام إدارة الخرائط الامتحانية - مسار القانون</div>
                        <div>مركز أورنمو - الإصدار 1.0</div>
                        <div>تم الإنشاء: ${dateStr}</div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
            
            showAlert('تم تحضير معلومات النظام للطباعة', 'success');
        }

        function printSetupReport() {
            printSectionReport('initial-setup');
        }

        // ===== النظام والصيانة =====
        function backupSystem() {
            const backup = {
                timestamp: new Date().toISOString(),
                data: JSON.parse(JSON.stringify(systemData)),
                description: 'نسخة احتياطية يدوية'
            };
            
            systemData.backups.push(backup);
            saveSystemData();
            
            // تحميل الملف
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `نسخة_احتياطية_مسار_القانون_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showAlert('تم إنشاء نسخة احتياطية بنجاح', 'success');
        }

        function restoreSystem() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (confirm('هل تريد استعادة هذه النسخة؟ سيتم استبدال جميع البيانات الحالية.')) {
                            systemData = backup.data;
                            saveSystemData();
                            location.reload();
                            showAlert('تم استعادة النسخة الاحتياطية بنجاح', 'success');
                        }
                    } catch (error) {
                        console.error('خطأ في استعادة النسخة:', error);
                        showAlert('الملف غير صالح', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            fileInput.click();
        }

        function exportFullData() {
            const dataStr = JSON.stringify(systemData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `بيانات_مسار_القانون_كاملة_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showAlert('تم تصدير قاعدة البيانات كاملة', 'success');
        }

        function showResetModal() {
            const confirmReset = document.getElementById('confirmReset');
            const resetBtn = document.getElementById('resetBtn');
            const resetPassword = document.getElementById('resetPassword');
            
            if (confirmReset) confirmReset.checked = false;
            if (resetBtn) resetBtn.disabled = true;
            if (resetPassword) resetPassword.value = 'admin';
            
            showModal('resetSystemModal');
        }

        function confirmSystemReset() {
            const password = document.getElementById('resetPassword')?.value;
            
            if (password !== systemData.settings.adminPassword) {
                showAlert('كلمة مرور الإدارة غير صحيحة', 'error');
                return;
            }
            
            const confirmReset = document.getElementById('confirmReset');
            if (!confirmReset || !confirmReset.checked) {
                showAlert('يرجى تأكيد عملية التصفير', 'error');
                return;
            }
            
            // إنشاء نسخة احتياطية قبل المسح
            backupSystem();
            
            // إعادة النظام للحالة المصنعية
            systemData = {
                settings: {
                    systemName: "مسار القانون",
                    centerName: "مركز أورنمو",
                    version: "1.0",
                    adminPassword: "admin"
                },
                departments: [],
                stages: [],
                subjects: [],
                students: [],
                halls: [],
                monitors: [],
                backups: systemData.backups // الاحتفاظ بالنسخ الاحتياطية السابقة
            };
            
            localStorage.setItem('lawPathSystemData', JSON.stringify(systemData));
            
            hideModal('resetSystemModal');
            showAlert('تم تصفير النظام بنجاح. جاري إعادة التحميل...', 'success');
            
            setTimeout(() => {
                location.reload();
            }, 2000);
        }

        // ===== أدوات المساعدة =====
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                modal.style.display = 'flex';
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        }

        function showAlert(message, type = 'info', duration = 5000) {
            const container = document.getElementById('alertContainer');
            if (!container) return;
            
            const alertId = 'alert-' + Date.now();
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.id = alertId;
            alert.innerHTML = `
                <i class="fas fa-${getAlertIcon(type)}"></i>
                <span>${message}</span>
                <button onclick="closeAlert('${alertId}')" style="margin-right: auto; background: none; border: none; color: inherit; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                closeAlert(alertId);
            }, duration);
        }

        function closeAlert(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.classList.remove('show');
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 500);
            }
        }

        function getAlertIcon(type) {
            const icons = {
                'success': 'check-circle',
                'error': 'exclamation-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // ===== وظائف الطباعة =====
        function generateSeatMapsPDF() {
            if (systemData.halls.length === 0) {
                showAlert('لا توجد قاعات لطباعة خرائطها', 'warning');
                return;
            }
            
            showAlert('جاري إعداد خرائط الجلوس للطباعة...', 'info');
            
            setTimeout(() => {
                window.print();
                showAlert('جاهز للطباعة', 'success');
            }, 1000);
        }

        function printDistributionReport() {
            showAlert('جاري إعداد تقرير التوزيع للطباعة...', 'info');
            
            setTimeout(() => {
                window.print();
                showAlert('جاهز للطباعة', 'success');
            }, 1000);
        }

        // ===== تحديث إحصائيات التقارير =====
        function updateReportStats() {
            updateElementText('reportStudentCount', systemData.students.length);
            updateElementText('reportHallCount', systemData.halls.length);
            updateElementText('reportMonitorCount', systemData.monitors.length);
            
            // حساب متوسط الإشغال
            const totalSeats = systemData.halls.reduce((sum, hall) => sum + hall.capacity, 0);
            const occupiedSeats = systemData.halls.reduce((sum, hall) => sum + (hall.occupied || 0), 0);
            const occupancyRate = totalSeats > 0 ? Math.round((occupiedSeats / totalSeats) * 100) : 0;
            updateElementText('reportOccupancy', occupancyRate + '%');
        }

        // ===== بيانات تجريبية للاختبار =====
        function addSampleData() {
            // إضافة أقسام
            if (systemData.departments.length === 0) {
                systemData.departments = [
                    { id: 'DEPT1', name: 'القانون العام', code: 'LAW1' },
                    { id: 'DEPT2', name: 'القانون الخاص', code: 'LAW2' },
                    { id: 'DEPT3', name: 'القانون الجنائي', code: 'LAW3' }
                ];
            }
            
            // إضافة مراحل
            if (systemData.stages.length === 0) {
                systemData.stages = [
                    { id: 'STAGE1', name: 'المرحلة الأولى', level: 1 },
                    { id: 'STAGE2', name: 'المرحلة الثانية', level: 2 },
                    { id: 'STAGE3', name: 'المرحلة الثالثة', level: 3 },
                    { id: 'STAGE4', name: 'المرحلة الرابعة', level: 4 }
                ];
            }
            
            // إضافة مواد
            if (systemData.subjects.length === 0) {
                systemData.subjects = [
                    { id: 'SUBJ1', name: 'المدخل لدراسة القانون', code: 'LAW101' },
                    { id: 'SUBJ2', name: 'القانون الدستوري', code: 'LAW102' },
                    { id: 'SUBJ3', name: 'قانون العقوبات', code: 'LAW201' }
                ];
            }
            
            // إضافة طلاب
            if (systemData.students.length === 0) {
                const sampleNames = [
                    'أحمد محمد علي', 'سارة عبدالله خالد', 'محمد سعيد حسن', 
                    'فاطمة إبراهيم عبدالرحمن', 'خالد ناصر العلي', 'نورة سعد الكواري',
                    'عبدالله راشد المالكي', 'مريم خليفة النعيمي', 'يوسف سالم القاسمي',
                    'حصة علي المنصوري'
                ];
                
                sampleNames.forEach((name, index) => {
                    systemData.students.push({
                        id: '2023' + (1000 + index),
                        name: name,
                        departmentId: systemData.departments[index % systemData.departments.length].id,
                        stageId: systemData.stages[index % systemData.stages.length].id,
                        subjectId: systemData.subjects[index % systemData.subjects.length].id,
                        hallId: null,
                        seatNumber: null
                    });
                });
            }
            
            // إضافة قاعات
            if (systemData.halls.length === 0) {
                systemData.halls = [
                    { id: 'H1', name: 'القاعة الرئيسية', capacity: 30, occupied: 0 },
                    { id: 'H2', name: 'قاعة المحاضرات ١', capacity: 25, occupied: 0 },
                    { id: 'H3', name: 'قاعة الامتحانات ٣', capacity: 20, occupied: 0 }
                ];
            }
            
            // إضافة مراقبين
            if (systemData.monitors.length === 0) {
                systemData.monitors = [
                    { id: 'M1', name: 'د. علي محمد أحمد', phone: '0551234567', halls: [] },
                    { id: 'M2', name: 'أ. سامي عبدالرحمن خالد', phone: '0557654321', halls: [] }
                ];
            }
            
            saveSystemData();
            updateDashboardStats();
            updateStudentsTable();
            updateHallsTable();
            updateMonitorsTable();
            updateFilters();
        }

        // ===== أدوات المطور =====
        window.lawPathSystem = {
            getData: () => systemData,
            saveData: () => saveSystemData(),
            resetData: () => {
                localStorage.clear();
                location.reload();
            },
            addSampleData: addSampleData,
            showSection: showSection,
            importJSON: importJSON,
            exportJSON: exportJSON
        };

        // ===== رسالة ترحيب للمطور =====
        console.log('%c⚖️ مسار القانون - مركز أورنمو', 'color: #1a237e; font-size: 16px; font-weight: bold;');
        console.log('%cنظام إدارة الخرائط الامتحانية لطلبة القانون', 'color: #283593;');
        console.log('%cالإصدار 1.0 | نظام متجاوب مع جميع الأجهزة', 'color: #3949ab;');
        console.log('%cجميع الأزرار والأقسام تعمل بشكل انسيابي', 'color: #2e7d32; font-weight: bold;');
        console.log('%cميزات الطباعة متاحة في كل قسم', 'color: #f57c00; font-weight: bold;');
    </script>
</body>
</html>
